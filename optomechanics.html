<html>
<title>Optomechanics in your browser</title>
	<head>
				<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
<style>
.mybutton {
	background-color:#00AA80;
	text-align:center;
	border-radius:5px;
	font-family:Helvetica;
    font-weight:100;
	padding:3px;
	user-select: none;
}
.mybutton:hover {
	background-color:#FF8000;
    cursor:pointer
}
.mybutton_animation {
    animation: 0.2s linear 0s 1 normal sweep_color;
}
@keyframes sweep_color { from { background-color:rgb(255,255,255); } to { background-color:rgb(255,200,0); } } 
</style>

<body style="margin:0; background-color:#000000">

<!-- 
First: the panel on the left, onto which the animation will be drawn.
Scripts are at the end of this page!
--->

<div style="width:70%;float:left">
	<svg id="canvas" viewBox="0 0 100 100">
		</svg>
</div>

<!-- 
And now: the text!
--->

<div style="float:left;max-width:24%;background-color:dimgrey;font-family:Helvetica;font-weight:100;color:#FFFFFF;padding:10px">

	<p style="font-size:24px;font-weight:800;background-color:orange;padding:5px;border-radius:5px">
Cavity Optomechanics Simulator
	</p>

	<div id="detuning_input_div" class="slider">
	<label>Detuning &Delta;/&Omega;=</label> <label id="detuning_text">1</label>
    <input id="detuning_input" style="width:100%" type="range" list="tickmarks" min="-3" max="3" value="1" step="0.01" oninput="change_detuning()">
    <datalist id="tickmarks">
        <option value="0" label="0"></option>
        <option value="1" label="1"></option>
        <option value="2" label="2"></option>
        <option value="-1" label="-1"></option>
        <option value="-2" label="-2"></option>
      </datalist>
	</div>

	<div id="kappa_input_div" class="slider">
        <label>Cavity decay &kappa;/&Omega;=</label> <label id="kappa_text">1</label>
        <input id="kappa_input" style="width:100%" type="range" list="tickmarks" min="0" max="3" value="1" step="0.01" oninput="change_kappa()">
        <datalist id="tickmarks">
            <option value="0" label="0"></option>
            <option value="0.1" label="0.1"></option>
            <option value="1" label="1"></option>
            <option value="2" label="2"></option>
          </datalist>
    </div>

    <div id="Gamma_input_div" class="slider">
        <label>Mechanical damping &Gamma;/&Omega;=</label> <label id="gamma_text">1</label>
        <input id="gamma_input" style="width:100%" type="range" list="tickmarks" min="-4" max="0" value="-2" step="0.01" oninput="change_gamma()">
        <datalist id="tickmarks">
            <option value="-4" label="1e-4"></option>
            <option value="-3" label="1e-3"></option>
            <option value="-2" label="1e-2"></option>
            <option value="-1" label="1e-1"></option>
            <option value="0" label="1"></option>
            </datalist>
    </div>

    <div id="g0_input_div" class="slider">
        <label>Coupling g<sub>0</sub>/&Omega;=</label> <label id="g0_text">1</label>
        <input id="g0_input" style="width:100%" type="range" list="tickmarks" min="0" max="0.001" value="0.0001" step="0.000001" oninput="change_g0()">
        <datalist id="tickmarks">
            <option value="0" label="0"></option>
            <option value="0.0001" label="10<sup>-4</sup>"></option>
            <option value="0.001" label="10<sup>-3</sup>"></option>
            </datalist>
    </div>

    <div id="alpha_in_input_div" class="slider">
        <label>Drive (photons/time) |&alpha;<sub>in</sub>|<sup>2</sup>/&Omega;=</label> <label id="alpha_in_text">1</label>
        <input id="alpha_in_input" style="width:100%" type="range" list="tickmarks" min="-3" max="6" value="1.0" step="0.01" oninput="change_alpha_in()">
        <datalist id="tickmarks">
            <option value="-3" label="10<sup>-3</sup>"></option>
            <option value="-2" label="10<sup>-2</sup>"></option>
            <option value="-1" label="10<sup>-1</sup>"></option>
            <option value="0" label="0"></option>
            <option value="1" label="10<sup>1</sup>"></option>
            <option value="2" label="10<sup>2</sup>"></option>
            <option value="3" label="10<sup>3</sup>"></option>
            <option value="4" label="10<sup>4</sup>"></option>
            <option value="5" label="10<sup>5</sup>"></option>
            <option value="6" label="10<sup>6</sup>"></option>
            </datalist>
    </div>

    <p class="mybutton" onclick="define_sweep_start(this)">Define sweep start</p>
    <p class="mybutton" onclick="define_sweep_end(this)">Define sweep end</p>
    <div id="sweep_time_input_div" class="slider">
        <label>Sweep time (times &Omega;)=</label> <label id="sweep_time_text">1</label>
        <input id="sweep_time_input" style="width:100%" type="range" list="tickmarks" min="1" max="6" value="2" step="0.01" oninput="change_sweep_time()">
        <datalist id="tickmarks">
            <option value="1" label="10"></option>
            <option value="2" label="1e2"></option>
            <option value="3" label="1e3"></option>
            <option value="4" label="1e4"></option>
            <option value="5" label="1e5"></option>
            </datalist>
    </div>

    <label>
    <input type="checkbox" onclick="activate_sweep(this)"/>
    <div>Activate sweep</div>
    </label>

	<p style="font-size:14;color:lightseagreen">Tirth Shah & Florian Marquardt 2020<br>OMT, supported by the E.U.</p>
</div>

<script>
// User interface actions
function change_detuning() {
    Detuning=parseFloat(document.getElementById('detuning_input').value)
    document.getElementById('detuning_text').innerHTML=Detuning
    if(sweep_active) {
        do_sweep()
    }
}

function change_kappa() {
    kappa=parseFloat(document.getElementById('kappa_input').value)
    document.getElementById('kappa_text').innerHTML=kappa
    LaserDrive=Math.sqrt(kappa)*alpha_in
    if(sweep_active) {
        do_sweep()
    }
}

function change_gamma() {
    Gamma=Math.pow(10,parseFloat(document.getElementById('gamma_input').value))
    document.getElementById('gamma_text').innerHTML=Gamma.toPrecision(2)
    if(sweep_active) {
        do_sweep()
    }
}

function change_g0() {
    g0=parseFloat(document.getElementById('g0_input').value)
    document.getElementById('g0_text').innerHTML=g0
    if(sweep_active) {
        do_sweep()
    }
}

function change_alpha_in() {
    alpha_in_2=Math.pow(10,parseFloat(document.getElementById('alpha_in_input').value))
    document.getElementById('alpha_in_text').innerHTML=alpha_in_2.toPrecision(2)
    alpha_in=Math.sqrt(alpha_in_2)
    LaserDrive=Math.sqrt(kappa)*alpha_in
    if(sweep_active) {
        do_sweep()
    }
}

function change_sweep_time() {
    sweep_time=Math.pow(10,parseFloat(document.getElementById('sweep_time_input').value))
    document.getElementById('sweep_time_text').innerHTML=sweep_time.toPrecision(2)
    if(sweep_active) {
        do_sweep()
    }
}

function animate_clicked_button(obj) {
    obj.classList.add('mybutton_animation')
    setTimeout(function(){
        	obj.classList.remove('mybutton_animation');
        }, 200)
}

function define_sweep_start(button_element) {
    Detuning_start=Detuning
    alpha_in_start=alpha_in
    kappa_start=kappa
    Gamma_start=Gamma
    g0_start=g0
    animate_clicked_button(button_element)
}

function define_sweep_end(button_element) {
    Detuning_end=Detuning
    alpha_in_end=alpha_in
    kappa_end=kappa
    Gamma_end=Gamma
    g0_end=g0
    animate_clicked_button(button_element)
}

function activate_sweep(checkboxbutton) {
    if(checkboxbutton.checked) {
        sweep_active=true
        do_sweep()
    } else {
        sweep_active=false
    }
}

function do_sweep() {
    time_idx=0

    tmax=max_time_idx*DT

    var SMALL_NUMBER=1e-10

    if(Math.abs(Detuning_end-Detuning_start)<SMALL_NUMBER) { Detuning_sweep=false } else { Detuning_sweep=true }
    if(Math.abs(alpha_in_end-alpha_in_start)<SMALL_NUMBER) { alpha_in_sweep=false } else { alpha_in_sweep=true }
    if(Math.abs(kappa_end-kappa_start)<SMALL_NUMBER) { kappa_sweep=false } else { kappa_sweep=true }
    if(Math.abs(Gamma_end-Gamma_start)<SMALL_NUMBER) { Gamma_sweep=false } else { Gamma_sweep=true }
    if(Math.abs(g0_end-g0_start)<SMALL_NUMBER) { g0_sweep=false } else { g0_sweep=true }

    X=[0.,0.,0.,0.]
    DT_big_step=sweep_time/max_time_idx
    var t=0.0
    var t_step=0.0

    for(time_idx=0;time_idx<max_time_idx;time_idx++) {
        s=time_idx*DT/tmax
        if(Detuning_sweep) { Detuning=(1-s)*Detuning_start+s*Detuning_end }
        if(alpha_in_sweep) { alpha_in=(1-s)*alpha_in_start+s*alpha_in_end }
        if(kappa_sweep) { kappa=(1-s)*kappa_start+s*kappa_end }
        if(Gamma_sweep) { Gamma=(1-s)*Gamma_start+s*Gamma_end }
        if(g0_sweep) { g0=(1-s)*g0_start+s*g0_end }
        LaserDrive=Math.sqrt(kappa)*alpha_in

        t_step=t_step+DT_big_step
        while(t<t_step) {
            rkstep()
            t+=DT
        }

        // keep records of time traces
        X_record[time_idx]=X[0]
        alpha2_record[time_idx]=X[2]*X[2]+X[3]*X[3]
    }

    plot_X_and_alpha2()
}

// graphics

function circle(x, y, r,color) {
	var shape = document.createElementNS ('http://www.w3.org/2000/svg', 'circle')
	shape.setAttribute ('cx', x)
	shape.setAttribute ('cy', y)
	shape.setAttribute ('r', r)
	shape.setAttribute('fill',color)
	canvas.appendChild(shape)
	return(shape)
}

function setAttributes(elem,attributes) {
    for (var i = 1; i < attributes.length; i+=2) {
        elem.setAttribute(attributes[i],attributes[i+1])
    }
}

function add_graphics() {
    args=Array.from(arguments)
    var shape = document.createElementNS("http://www.w3.org/2000/svg", args[0])
    setAttributes(shape,args)
    canvas.appendChild(shape)
    return shape
}

function HTMLObject(x,y,width,height,htmlcode,textstyle) {
    var fo= document.createElementNS ('http://www.w3.org/2000/svg', 'foreignObject')
    fo.setAttribute("x",x)
    fo.setAttribute("y",y)
    fo.setAttribute("width",width)
    fo.setAttribute("height",height)         
    var newDiv = document.createElement('div')
    newDiv.style=textstyle
    newDiv.innerHTML=htmlcode
    fo.appendChild(newDiv)
    canvas.appendChild(fo)
    return(fo)
}

function plot(x,y,x0,y0,width,height,color,linewidth,existing_shape) {
    var string,X,Y
    var j,N=x.length

    var maxy=Math.max(...y)
    var miny=Math.min(...y)
    var maxx=Math.max(...x)
    var minx=Math.min(...x)
    if(maxx-minx<1e-3) { maxx=minx+1e-3 }
    if(maxy-miny<1e-3) { maxy=miny+1e-3 }
    var sy=height/(maxy-miny)
    var sx=width/(maxx-minx)
    y0-=miny*sy
    x0-=minx*sx

    for(j=0;j<N;j++) {
        X=x[j]
        Y=y[j]
        if(j==0) {
            string=X+","+Y
        } else {
            string+=" "+X+","+Y
        }
    }

    if(existing_shape!=null) {
        existing_shape.setAttribute("points",string)
        existing_shape.setAttribute("transform","translate("+x0+","+y0+") scale("+sx+","+sy+")")
    } else {
        return(add_graphics("polyline","points",string,"stroke",color,"stroke-width",
        linewidth, "stroke-linejoin", "round", "vector-effect","non-scaling-stroke",
        "fill","none","transform","translate("+x0+","+y0+") scale("+sx+","+sy+")"))
    }
}

function plot_background(x0,y0,width,height,fillcolor,bordercolor,borderwidth) {
    return(add_graphics("rect","x",x0,"y",y0,"width",width,"height",height,"fill",fillcolor,"stroke",bordercolor,"stroke-width",borderwidth))
}

// Runge Kutta and animation

function rhs(Y) {
    // Y=[Position,Velocity,alpha_re,alpha_im]
    Delta=Detuning+g0*Y[0]
    return( [Y[1],-Y[0] - Gamma*Y[1] + 2*g0*(Y[3]*Y[3]+Y[2]*Y[2]) ,-Delta*Y[3]-0.5*kappa*Y[2]+LaserDrive, Delta*Y[2]-0.5*kappa*Y[3]] )
}

function add_mul(c,a,lambda,b) { // set c=a+lambda*b for whole arrays
    for(j=0;j<a.length;j++) {
        c[j]=a[j]+lambda*b[j]
    }
}

// Runge Kutta 4th order
function rkstep() {
    dX1=rhs(X)
    add_mul(Xnew,X,0.5*DT,dX1)
    dX2=rhs(Xnew)
    add_mul(Xnew,X,0.5*DT,dX2)
    dX3=rhs(Xnew)
    add_mul(Xnew,X,DT,dX3)
    dX4=rhs(Xnew)
    for(j=0;j<X.length;j++) {
        X[j]+=DT6*(dX1[j]+2*dX2[j]+2*dX3[j]+dX4[j])
    }
}

function plot_X_and_alpha2() { // update both plot panels
    plot(times_record,X_record,TIMETRACE_X0,TIMETRACE_Y0,TIMETRACE_XWIDTH,
        TIMETRACE_YWIDTH,TIMETRACE_COLOR,TIMETRACE_LINEWIDTH,shape_timetrace)
    plot(times_record,alpha2_record,TIMETRACE_ALPHA2_X0,TIMETRACE_ALPHA2_Y0,TIMETRACE_ALPHA2_XWIDTH,
        TIMETRACE_ALPHA2_YWIDTH,TIMETRACE_COLOR,TIMETRACE_LINEWIDTH,shape_alpha2_timetrace)
}

function animate() {
    if(!sweep_active) { // if we are not currently in sweeping mode
        rkstep()

        // keep records of time traces
        X_record[time_idx]=X[0]
        alpha2_record[time_idx]=X[2]*X[2]+X[3]*X[3]
        time_idx+=1
        if(time_idx>=max_time_idx) { // wrap around
            time_idx=0
        }

        // show graphics (update plots)
        shape_mass_point.setAttribute("cx",MASSPOINT_X0+MASSPOINT_XSCALE*X[0])

        plot_X_and_alpha2()
    }
}

//============ MAIN ==========
// Setting up parameters and graphics, starting animation

// Graphics parameters
MASSPOINT_X0=50
MASSPOINT_Y0=70
MASSPOINT_XSCALE=0.01
MASSPOINT_RADIUS=3

TIMETRACE_COLOR="orange"
TIMETRACE_LINEWIDTH=2
PLOT_BACKGROUND_COLOR="dimgrey"
PLOT_BORDER_COLOR="white"
PLOT_BORDER_WIDTH=0.2
PLOT_LABEL_HEIGHT=5
PLOT_LABEL_SHIFT=-2
PLOT_LABEL_BACKGROUND_COLOR="orange"
PLOT_LABEL_TEXT_COLOR="white"
PLOT_LABEL_BEGIN="<p style='margin:auto;background-color:rgba(0,150,200,0.8);width:30%;padding:1px;border-radius:2px'>"
PLOT_LABEL_END="</p>"
PLOT_LABEL_TEXT_STYLE="font-size:2;font-family:Helvetica;font-weight:100;color:white"

TIMETRACE_X0=10
TIMETRACE_Y0=30
TIMETRACE_XWIDTH=80
TIMETRACE_YWIDTH=-10

TIMETRACE_ALPHA2_Y0=15
TIMETRACE_ALPHA2_X0=10
TIMETRACE_ALPHA2_YWIDTH=-10
TIMETRACE_ALPHA2_XWIDTH=80

// Numerics parameters
DT=0.2
DT6=DT/6.0

// parameters for display
max_time_idx=973 // how many points to store for displaying the time trace

// Physics
// Variables
X=[1.0,0.0,0.0,0.0] // position,velocity,real(alpha),imag(alpha)
Xnew=Array(X.length)

sweep_active=false // whether we are in sweeping mode
alpha_in=1.0 // because it will be accessed in change_kappa already

// Parameters: Obtain them from sliders for the first time
change_detuning() // obtain Detuning value
change_kappa()
change_gamma()
change_g0()
change_alpha_in()
change_sweep_time()

// prepare time trace
X_record=new Array(max_time_idx)
alpha2_record=new Array(max_time_idx)
times_record=new Array(max_time_idx)
for(j=0;j<max_time_idx;j++) {
    times_record[j]=j*DT
    X_record[j]=0.0
    alpha2_record[j]=0.0
}
time_idx=0

// Preparing graphics
canvas=document.getElementById("canvas")
shape_mass_point=circle(MASSPOINT_X0+MASSPOINT_XSCALE*X[0],MASSPOINT_Y0,MASSPOINT_RADIUS,"orange")
// plot of time trace (curve will be modified later)
plot_background(TIMETRACE_X0,TIMETRACE_Y0+TIMETRACE_ALPHA2_YWIDTH,TIMETRACE_XWIDTH,-TIMETRACE_YWIDTH,
PLOT_BACKGROUND_COLOR,PLOT_BORDER_COLOR,PLOT_BORDER_WIDTH)
shape_timetrace=plot(times_record,X_record,TIMETRACE_X0,TIMETRACE_Y0,TIMETRACE_XWIDTH,
    TIMETRACE_YWIDTH,TIMETRACE_COLOR,TIMETRACE_LINEWIDTH,null)
    HTMLObject(TIMETRACE_X0,TIMETRACE_Y0+TIMETRACE_ALPHA2_YWIDTH+PLOT_LABEL_SHIFT,TIMETRACE_XWIDTH,
PLOT_LABEL_HEIGHT,PLOT_LABEL_BEGIN+"Position x/x<sub>ZPF</sub>"+PLOT_LABEL_END,PLOT_LABEL_TEXT_STYLE)

plot_background(TIMETRACE_ALPHA2_X0,TIMETRACE_ALPHA2_Y0+TIMETRACE_ALPHA2_YWIDTH,TIMETRACE_ALPHA2_XWIDTH,
    -TIMETRACE_ALPHA2_YWIDTH,PLOT_BACKGROUND_COLOR,PLOT_BORDER_COLOR,PLOT_BORDER_WIDTH)
shape_alpha2_timetrace=plot(times_record,alpha2_record,TIMETRACE_ALPHA2_X0,TIMETRACE_ALPHA2_Y0,TIMETRACE_ALPHA2_XWIDTH,
    TIMETRACE_ALPHA2_YWIDTH,TIMETRACE_COLOR,TIMETRACE_LINEWIDTH,null)
HTMLObject(TIMETRACE_ALPHA2_X0,TIMETRACE_ALPHA2_Y0+TIMETRACE_ALPHA2_YWIDTH+PLOT_LABEL_SHIFT,TIMETRACE_ALPHA2_XWIDTH,
PLOT_LABEL_HEIGHT,PLOT_LABEL_BEGIN+"Intensity |&alpha;|<sup>2</sup>"+PLOT_LABEL_END,PLOT_LABEL_TEXT_STYLE)
    //rubberbox(TIMETRACE_X0,TIMETRACE_Y0+TIMETRACE_ALPHA2_YWIDTH,1,
//   "Intensity |&alpha;|<sup>2</sup>",PLOT_LABEL_BACKGROUND_COLOR,PLOT_LABEL_TEXT_COLOR,PLOT_LABEL_TEXT_STYLE)


// Start animation loop
setInterval(animate,20)

</script>


</body>
</html>
