<html>
<title>Optomechanics in your browser</title>
	<head>
				<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
<style>
#button {
	background-color:#00AA80;
	text-align:center;
	border-radius:5px;
	font-family:Verdana;
	padding:3px;
	user-select: none;
}
#button:hover {
	background-color:#FF8000
}
#slider {
	background-color:#00AA80;
	border-radius:5px;
	font-family:Verdana;
	padding:3px;
}
</style>

<body style="margin:0; background-color:#000000">

<!-- 
First: the panel on the left, onto which the animation will be drawn.
Scripts are at the end of this page!
--->

<div style="width:70%;float:left">
	<svg id="canvas" viewBox="0 0 100 100">
		</svg>
</div>

<!-- 
And now: the text!
--->

<div style="float:left;max-width:24%;background-color:dimgrey;font-family:Helvetica;font-weight:100;color:#FFFFFF;padding:10px">

	<p style="font-size:24px;font-weight:800;background-color:orange;padding:5px;border-radius:5px">
Cavity Optomechanics Simulator
	</p>

	<div id="detuning_input_div" class="slider">
	<label>Detuning &Delta;/&Omega;=</label> <label id="detuning_text">1</label>
    <input id="detuning_input" style="width:100%" type="range" list="tickmarks" min="-3" max="3" value="1" step="0.01" oninput="change_detuning()">
    <datalist id="tickmarks">
        <option value="0" label="0"></option>
        <option value="1" label="1"></option>
        <option value="2" label="2"></option>
        <option value="-1" label="-1"></option>
        <option value="-2" label="-2"></option>
      </datalist>
	</div>

	<div id="kappa_input_div" class="slider">
        <label>Cavity decay &kappa;/&Omega;=</label> <label id="kappa_text">1</label>
        <input id="kappa_input" style="width:100%" type="range" list="tickmarks" min="0" max="3" value="1" step="0.01" oninput="change_kappa()">
        <datalist id="tickmarks">
            <option value="0" label="0"></option>
            <option value="0.1" label="0.1"></option>
            <option value="1" label="1"></option>
            <option value="2" label="2"></option>
          </datalist>
    </div>

    <div id="Gamma_input_div" class="slider">
        <label>Mechanical damping &Gamma;/&Omega;=</label> <label id="gamma_text">1</label>
        <input id="gamma_input" style="width:100%" type="range" list="tickmarks" min="-4" max="0" value="-2" step="0.01" oninput="change_gamma()">
        <datalist id="tickmarks">
            <option value="-4" label="1e-4"></option>
            <option value="-3" label="1e-3"></option>
            <option value="-2" label="1e-2"></option>
            <option value="-1" label="1e-1"></option>
            <option value="0" label="1"></option>
            </datalist>
    </div>

    <div id="g0_input_div" class="slider">
        <label>Coupling g<sub>0</sub>/&Omega;=</label> <label id="g0_text">1</label>
        <input id="g0_input" style="width:100%" type="range" list="tickmarks" min="0" max="0.001" value="0.0001" step="0.000001" oninput="change_g0()">
        <datalist id="tickmarks">
            <option value="0" label="0"></option>
            <option value="0.0001" label="10<sup>-4</sup>"></option>
            <option value="0.001" label="10<sup>-3</sup>"></option>
            </datalist>
    </div>

    <div id="alpha_in_input_div" class="slider">
        <label>Drive (photons/time) |&alpha;<sub>in</sub>|<sup>2</sup>/&Omega;=</label> <label id="alpha_in_text">1</label>
        <input id="alpha_in_input" style="width:100%" type="range" list="tickmarks" min="-3" max="6" value="1.0" step="0.01" oninput="change_alpha_in()">
        <datalist id="tickmarks">
            <option value="-3" label="10<sup>-3</sup>"></option>
            <option value="-2" label="10<sup>-2</sup>"></option>
            <option value="-1" label="10<sup>-1</sup>"></option>
            <option value="0" label="0"></option>
            <option value="1" label="10<sup>1</sup>"></option>
            <option value="2" label="10<sup>2</sup>"></option>
            <option value="3" label="10<sup>3</sup>"></option>
            <option value="4" label="10<sup>4</sup>"></option>
            <option value="5" label="10<sup>5</sup>"></option>
            <option value="6" label="10<sup>6</sup>"></option>
            </datalist>
    </div>

	<p style="font-size:14;color:lightseagreen">Florian Marquardt 2020<br>OMT, supported by the E.U.</p>
</div>

<script>
// graphics routines

function circle(x, y, r,color) {
	var shape = document.createElementNS ('http://www.w3.org/2000/svg', 'circle')
	shape.setAttribute ('cx', x)
	shape.setAttribute ('cy', y)
	shape.setAttribute ('r', r)
	shape.setAttribute('fill',color)
	canvas.appendChild(shape)
	return(shape)
}

function change_detuning() {
    Detuning=parseFloat(document.getElementById('detuning_input').value)
    document.getElementById('detuning_text').innerHTML=Detuning
}

function change_kappa() {
    kappa=parseFloat(document.getElementById('kappa_input').value)
    document.getElementById('kappa_text').innerHTML=kappa
    LaserDrive=Math.sqrt(kappa)*alpha_in
}

function change_gamma() {
    Gamma=Math.pow(10,parseFloat(document.getElementById('gamma_input').value))
    document.getElementById('gamma_text').innerHTML=Gamma.toPrecision(2)
}

function change_g0() {
    g0=parseFloat(document.getElementById('g0_input').value)
    document.getElementById('g0_text').innerHTML=g0
}

function change_alpha_in() {
    alpha_in=Math.pow(10,parseFloat(document.getElementById('alpha_in_input').value))
    document.getElementById('alpha_in_text').innerHTML=alpha_in.toPrecision(2)
    LaserDrive=Math.sqrt(kappa)*alpha_in
}

function setAttributes(elem,attributes) {
    for (var i = 1; i < attributes.length; i+=2) {
        elem.setAttribute(attributes[i],attributes[i+1])
    }
}

function add_graphics() {
    args=Array.from(arguments)
    var shape = document.createElementNS("http://www.w3.org/2000/svg", args[0])
    setAttributes(shape,args)
    canvas.appendChild(shape)
    return shape
}

function plot(x,y,x0,y0,sx,sy,color,linewidth,existing_shape) {
    var string,X,Y
    var j,N=x.length

    for(j=0;j<N;j++) {
        X=x[j]
        Y=y[j]
        if(j==0) {
            string=X+","+Y
        } else {
            string+=" "+X+","+Y
        }
    }

    if(existing_shape!=null) {
        existing_shape.setAttribute("points",string)
    } else {
        return(add_graphics("polyline","points",string,"stroke",color,"stroke-width",
        linewidth,"vector-effect","non-scaling-stroke",
        "fill","none","transform","translate("+x0+","+y0+") scale("+sx+","+sy+")"))
    }
}

// Runge Kutta and animation

function rhs(Y) {
    // Y=[Position,Velocity,alpha_re,alpha_im]
    Delta=Detuning+g0*Y[0]
    return( [Y[1],-Y[0] - Gamma*Y[1] + 2*g0*(Y[3]*Y[3]+Y[2]*Y[2]) ,-Delta*Y[3]-0.5*kappa*Y[2]+LaserDrive, Delta*Y[2]-0.5*kappa*Y[3]] )
}

function add_mul(c,a,lambda,b) { // set c=a+lambda*b for whole arrays
    for(j=0;j<a.length;j++) {
        c[j]=a[j]+lambda*b[j]
    }
}

function animate() {
    // Runge Kutta 4th order
    dX1=rhs(X)
    add_mul(Xnew,X,0.5*DT,dX1)
    dX2=rhs(Xnew)
    add_mul(Xnew,X,0.5*DT,dX2)
    dX3=rhs(Xnew)
    add_mul(Xnew,X,DT,dX3)
    dX4=rhs(Xnew)
    for(j=0;j<X.length;j++) {
        X[j]+=DT6*(dX1[j]+2*dX2[j]+2*dX3[j]+dX4[j])
    }

    X_record[time_idx]=X[0]
    alpha2_record[time_idx]=X[2]*X[2]+X[3]*X[3]
    time_idx+=1
    if(time_idx>=max_time_idx) {
        time_idx=0
    }

    shape_mass_point.setAttribute("cx",MASSPOINT_X0+MASSPOINT_XSCALE*X[0])
    plot(times_record,X_record,TIMETRACE_X0,TIMETRACE_Y0,TIMETRACE_XSCALE,
    TIMETRACE_YSCALE,TIMETRACE_COLOR,TIMETRACE_WIDTH,shape_timetrace)
    plot(times_record,alpha2_record,TIMETRACE_X0,TIMETRACE_ALPHA2_Y0,TIMETRACE_XSCALE,
    TIMETRACE_ALPHA2_YSCALE,TIMETRACE_COLOR,TIMETRACE_WIDTH,shape_alpha2_timetrace)
}

//============ MAIN ==========
// Setting up parameters and graphics, starting animation

// Graphics parameters
MASSPOINT_X0=50
MASSPOINT_Y0=70
MASSPOINT_XSCALE=2
MASSPOINT_RADIUS=5

TIMETRACE_COLOR="orange"
TIMETRACE_WIDTH=2
TIMETRACE_X0=10
TIMETRACE_Y0=30
TIMETRACE_XSCALE=1
TIMETRACE_YSCALE=-0.5

TIMETRACE_ALPHA2_Y0=20
TIMETRACE_ALPHA2_YSCALE=-0.8

// Numerics parameters
DT=0.2
DT6=DT/6.0

// parameters for display
max_time_idx=400 // how many points to store for displaying time trace

// Physics
// Variables
X=[1.0,0.0,0.0,0.0] // position,velocity,real(alpha),imag(alpha)
Xnew=Array(X.length)

// Parameters: Obtain them from sliders for the first time
change_detuning() // obtain Detuning value
alpha_in=1.0 // because it will be accessed in change_kappa already
change_kappa()
change_gamma()
change_g0()
change_alpha_in()

// prepare time trace
X_record=new Array(max_time_idx)
alpha2_record=new Array(max_time_idx)
times_record=new Array(max_time_idx)
for(j=0;j<max_time_idx;j++) {
    times_record[j]=j*DT
    X_record[j]=0.0
    alpha2_record[j]=0.0
}
time_idx=0

// Preparing graphics
canvas=document.getElementById("canvas")
shape_mass_point=circle(MASSPOINT_X0+MASSPOINT_XSCALE*X[0],MASSPOINT_Y0,MASSPOINT_RADIUS,"orange")
// plot of time trace (curve will be modified later)
shape_timetrace=plot(times_record,X_record,TIMETRACE_X0,TIMETRACE_Y0,
    TIMETRACE_XSCALE,TIMETRACE_YSCALE,TIMETRACE_COLOR,TIMETRACE_WIDTH,null)
shape_alpha2_timetrace=plot(times_record,alpha2_record,TIMETRACE_X0,TIMETRACE_ALPHA2_Y0,
    TIMETRACE_XSCALE,TIMETRACE_ALPHA2_YSCALE,TIMETRACE_COLOR,TIMETRACE_WIDTH,null)

// Start animation loop
setInterval(animate,20)

</script>


</body>
</html>
